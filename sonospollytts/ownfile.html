<script type="text/javascript">

    RED.nodes.registerType("ownfile", {
        category: 'SonosPollyTTS',
        defaults: {
            name: { value: "" },
            selectedFile: { value: "", required: true }
        },
        color: '#FFF9FF',
        inputs: 1,
        outputs: 1,
        icon: 'file.png',
        paletteLabel: 'Own File',
        label: function () {
            return this.name || this.selectedFile.replace("OwnFile_", '').replace(".mp3", '');
        },
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {

            // 27/02/2020 Upload  file or files
            $("#ownFileUpload").change(function (e) {
                var oFiles;
                oFiles = this.files;
                $.each(oFiles, function (i, file) {
                    var fdata = new FormData();
                    fdata.append("customTTS", file);

                    $.ajax({
                        url: "node-red-contrib-sonospollytts",
                        type: "POST",
                        data: fdata, //add the FormData object to the data parameter
                        processData: false, //tell jquery not to process data
                        contentType: false,
                        success: function (response, status, jqxhr) {
                            refreshOwnFileCombo();
                        },
                        error: function (jqxhr, status, errorMessage) {
                            //handle error
                            alert("Error " + errorMessage + " " + status)
                        }
                    });
                });
            });

            // Get Ownfile list
            $.getJSON('getOwnFilesList', (data) => {
                data.sort().forEach(oFile => {
                    $("#node-input-selectedFile").append($("<option></option>")
                        .attr("value", oFile.filename)
                        .text(oFile.name)
                    )
                });
                $("#node-input-selectedFile").val(typeof this.selectedFile === "undefined" ? "" : this.selectedFile)
            });


            // Delete selected file
            $("#deleteSelectedFile").click(function () {
                $.getJSON('deleteOwnFile?FileName=' + $("#node-input-selectedFile").val() , (data) => {
                    refreshOwnFileCombo();
                });
            });


            function refreshOwnFileCombo() {
                // Refresh the combo
                $('#node-input-selectedFile')
                    .find('option')
                    .remove()
                    .end();
                $.getJSON('getOwnFilesList', (data) => {
                    data.sort().forEach(oFile => {
                        $("#node-input-selectedFile").append($("<option></option>")
                            .attr("value", oFile.filename)
                            .text(oFile.name)
                        )
                    });
                });
            }

        }
    });
</script>


<script type="text/x-red" data-template-name="ownfile">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Own File">
    </div>
    <div class="form-row">
        <label for="node-input-selectedFile"><i class="fa fa-file-audio-o"></i> File to be played</label>
        <select id="node-input-selectedFile"></select> <input id="deleteSelectedFile" type="button" value="Delete selected file">
    </div>
    <div class="form-row">
        <label><i class="fa fa-upload"></i> Upload files</label>
        <input id="ownFileUpload" type="file" multiple="multiple">
    </div>
</script>

<script type="text/x-red" data-help-name="ownfile">
    <p>This node allow you to play your own .mp3 file.<br/>
        You can upload multiple files at once, but only mp3 files are allowed.</p>
 
</script>